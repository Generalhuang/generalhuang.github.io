<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>日志Sys/App CPU、麦克风、内存、算法与网络分析</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%); color: #333; min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; background-color: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); padding: 30px; position: relative; overflow: hidden; }
    .container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; background: linear-gradient(90deg, #3498db, #2ecc71, #ff6b6b, #9b59b6); }
    header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eaeaea; }
    h1 { color: #2c3e50; margin-bottom: 12px; font-size: 32px; }
    .description { color: #7f8c8d; font-size: 16px; max-width: 800px; margin: 0 auto; line-height: 1.5; }
    .upload-section { display: flex; flex-direction: column; align-items: center; gap: 18px; margin-bottom: 30px; padding: 25px; background-color: #f8f9fa; border-radius: 10px; border: 2px dashed #ddd; transition: all 0.3s; }
    .upload-section:hover { border-color: #3498db; background-color: #edf7fd; }
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; cursor: pointer; }
    .file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    .btn { background: linear-gradient(to right, #3498db, #2ecc71); color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); }
    .btn:active { transform: translateY(0); }
    #filename { margin-left: 12px; color: #7f8c8d; font-style: italic; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #info { margin-top: 10px; color: #27ae60; font-weight: 500; text-align: center; font-size: 16px; }
    .tabs { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; }
    .tab { padding: 12px 20px; background: #f1f5f9; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; border: 2px solid transparent; font-size: 14px; }
    .tab.active { background: #3498db; color: white; border-color: #2980b9; }
    .tab:hover:not(.active) { background: #e3e8f2; }
    .charts-container { display: flex; flex-direction: column; gap: 25px; }
    .chart-box { display: block; }
    .chart-box.hidden { display: none; }
    .chart-container { position: relative; width: 100%; height: 500px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); background: white; }
    .chart { width: 100%; height: 100%; }
    .legend { display: flex; justify-content: center; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: #f8f9fa; border-radius: 6px; font-size: 14px; }
    .legend-color { width: 16px; height: 16px; border-radius: 3px; }
    .app-color { background-color: #5470c6; }
    .sys-color { background-color: #91cc75; }
    .high-cpu-color { background-color: #ff6b6b; }
    .running-color { background-color: #2ecc71; }
    .idle-color { background-color: #95a5a6; }
    .tm-color { background-color: #9b59b6; }
    .fm-color { background-color: #3498db; }
    .proc-color { background-color: #e74c3c; }
    .instructions { margin-top: 35px; padding: 25px; background: linear-gradient(to bottom, #f8f9fa, #edf2f7); border-radius: 10px; border-left: 5px solid #3498db; }
    .instructions h3 { color: #2c3e50; margin-bottom: 18px; font-size: 20px; display: flex; align-items: center; gap: 10px; }
    .instructions h3:before { content: '💡'; }
    .instructions ul { padding-left: 25px; }
    .instructions li { margin-bottom: 12px; line-height: 1.6; color: #5a6778; }
    .instructions li strong { color: #2c3e50; }
    .highlight { background-color: #fff6e9; padding: 3px 6px; border-radius: 4px; color: #e67e22; font-weight: 500; }
    .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eaeaea; color: #7f8c8d; font-size: 14px; }
    @media (max-width: 768px) { .container { padding: 20px; } .chart-container { height: 400px; } h1 { font-size: 28px; } .btn { padding: 12px 22px; } .tabs { flex-direction: column; align-items: center; } .tab { width: 100%; text-align: center; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>日志分析工具：设备/算法/网络/性能</h1>
      <p class="description">上传日志文件，自动解析四大维度：设备、算法、网络、性能；保持原有图表风格与交互。</p>
    </header>

    <div class="upload-section">
      <div class="file-input-wrapper">
        <button class="btn"><i>📁</i> 选择日志文件</button>
        <input type="file" id="fileinput" accept=".log,.txt,.xlog" />
      </div>
      <span id="filename"></span>
      <span id="info"></span>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="all">显示所有图表</div>
      <div class="tab" data-tab="device">设备</div>
      <div class="tab" data-tab="algo">算法</div>
      <div class="tab" data-tab="network">网络</div>
      <div class="tab" data-tab="performance">性能</div>
      <div class="tab" data-tab="player">播放器</div>
    </div>

    <div class="charts-container">
      <!-- 设备：Mic 与 Meter -->
      <div class="chart-box" id="mic-chart-box">
        <div class="legend">
          <div class="legend-item"><div class="legend-color running-color"></div><span>运行中 (runing)</span></div>
          <div class="legend-item"><div class="legend-color idle-color"></div><span>空闲 (idle)</span></div>
        </div>
        <div class="chart-container"><div id="mic-chart" class="chart"></div></div>
      </div>
      <div class="chart-box" id="meter-chart-box">
        <div class="legend">
          <div class="legend-item"><div class="legend-color app-color"></div><span>Preprocess</span></div>
          <div class="legend-item"><div class="legend-color sys-color"></div><span>InDevMeter</span></div>
          <div class="legend-item"><div class="legend-color high-cpu-color"></div><span>OutDevMeter</span></div>
        </div>
        <div class="chart-container"><div id="meter-chart" class="chart"></div></div>
      </div>

      <!-- 设备名：采集/播放 -->
      <div class="chart-box" id="device-chart-box">
        <div class="legend">
          <div class="legend-item"><div class="legend-color running-color"></div><span>采集设备(inDev)</span></div>
          <div class="legend-item"><div class="legend-color high-cpu-color"></div><span>播放设备(outDev)</span></div>
        </div>
        <div class="chart-container"><div id="device-chart" class="chart"></div></div>
      </div>

      <!-- 算法：3A 开关、回声泄漏 -->
      <div class="chart-box" id="algo-chart-box">
        <div class="chart-container"><div id="algo-chart" class="chart"></div></div>
      </div>

      <!-- 网络：上/下行 -->
      <div class="chart-box" id="network-chart-box">
        <div class="chart-container"><div id="network-chart" class="chart"></div></div>
      </div>

      <!-- 新增：网络丢包图表 -->
      <div class="chart-box" id="network-drop-chart-box">
        <div class="legend">
          <div class="legend-item"><div class="legend-color" style="background-color: #e74c3c;"></div><span>丢包时长</span></div>
        </div>
        <div class="chart-container"><div id="network-drop-chart" class="chart"></div></div>
      </div>

      <!-- 性能：CPU、内存 -->
      <div class="chart-box" id="cpu-chart-box">
        <div class="legend">
          <div class="legend-item"><div class="legend-color app-color"></div><span>App CPU</span></div>
          <div class="legend-item"><div class="legend-color sys-color"></div><span>Sys CPU</span></div>
          <div class="legend-item"><div class="legend-color high-cpu-color"></div><span>CPU使用率 > 90%</span></div>
        </div>
        <div class="chart-container"><div id="cpu-chart" class="chart"></div></div>
      </div>

      <div class="chart-box" id="memory-chart-box">
        <div class="legend">
          <div class="legend-item"><div class="legend-color tm-color"></div><span>总内存 (TM)</span></div>
          <div class="legend-item"><div class="legend-color fm-color"></div><span>空闲内存 (FM)</span></div>
          <div class="legend-item"><div class="legend-color proc-color"></div><span>程序使用内存 (Proc)</span></div>
        </div>
        <div class="chart-container"><div id="memory-chart" class="chart"></div></div>
      </div>

      <!-- 播放器：Player, Decoder, Jitter, Demuxer -->
      <div class="chart-box" id="player-chart-box">
        <div class="legend">
          <div class="legend-item"><div class="legend-color" style="background-color: #3498db;"></div><span>输入帧数</span></div>
          <div class="legend-item"><div class="legend-color" style="background-color: #e74c3c;"></div><span>输出帧数</span></div>
        </div>
        <div class="chart-container"><div id="player-chart" class="chart"></div></div>
      </div>
      
      <!-- 新增：解码器图表容器 -->
      <div class="chart-box" id="decoder-chart-box">
        <div class="legend">
          <div class="legend-item"><div class="legend-color" style="background-color: #4bc07d;"></div><span>输入帧</span></div>
          <div class="legend-item"><div class="legend-color" style="background-color: #7f8c8d;"></div><span>解码帧</span></div>
          <div class="legend-item"><div class="legend-color" style="background-color: #f39c12;"></div><span>输出帧</span></div>
        </div>
        <div class="chart-container"><div id="decoder-chart" class="chart"></div></div>
      </div>

      <!-- 新增：Jitter图表容器 -->
      <div class="chart-box" id="jitter-chart-box">
        <div class="legend">
          <div class="legend-item"><div class="legend-color" style="background-color: #2b77da;"></div><span>输入帧</span></div>
          <div class="legend-item"><div class="legend-color" style="background-color: #e74c3c;"></div><span>输出帧</span></div>
        </div>
        <div class="chart-container"><div id="jitter-chart" class="chart"></div></div>
      </div>

      <!-- 新增：Demuxer图表容器 -->
      <div class="chart-box" id="demuxer-chart-box">
        <div class="legend">
          <div class="legend-item"><div class="legend-color" style="background-color: #2980b9;"></div><span>输入帧</span></div>
          <div class="legend-item"><div class="legend-color" style="background-color: #95a5a6;"></div><span>刷新帧</span></div>
          <div class="legend-item"><div class="legend-color" style="background-color: #16a085;"></div><span>输出帧</span></div>
        </div>
        <div class="chart-container"><div id="demuxer-chart" class="chart"></div></div>
      </div>

    </div>

    <div class="instructions">
      <h3>使用说明</h3>
      <ul>
        <li>上传日志文件后，系统会自动解析四个维度的数据</li>
        <li>使用选项卡切换查看不同维度，可缩放、平移、保存图片</li>
        <li><span class="highlight">CPU使用率超过90%的点将标红</span></li>
      </ul>
    </div>

    <div class="footer"><p>日志分析工具 © 2025</p></div>
  </div>

  <script type="module">
    import { parseAndDrawPerformance } from './perf.js';
    import { parseAndDrawDevice } from './device.js';
    import { parseAndDrawAlgo } from './algo.js';
    import { parseAndDrawNetwork } from './network.js';
    import { parseAndDrawPlayer } from './player.js';  

    const fileInput = document.getElementById('fileinput');
    const filenameEl = document.getElementById('filename');
    const infoEl = document.getElementById('info');

    function resizeAll() {
      if (window.cpuChart) window.cpuChart.resize();
      if (window.memoryChart) window.memoryChart.resize();
      if (window.micChart) window.micChart.resize();
      if (window.meterChart) window.meterChart.resize();
      if (window.deviceChart) window.deviceChart.resize();
      if (window.algoChart) window.algoChart.resize();
      if (window.networkChart) window.networkChart.resize();
      // 新增：确保所有播放器图表都能自适应
      if (window.playerChart) window.playerChart.resize();
      if (window.decoderChart) window.decoderChart.resize();
      if (window.jitterChart) window.jitterChart.resize();
      if (window.demuxerChart) window.demuxerChart.resize();
    }

    function switchTab(tabName){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      const target = document.querySelector(`.tab[data-tab="${tabName}"]`);
      if (target) target.classList.add('active');
      
      const showAll = tabName === 'all';
      const toShow = {
        device: ['mic-chart-box','meter-chart-box','device-chart-box'],
        algo: ['algo-chart-box'],
        network: ['network-chart-box', 'network-drop-chart-box'],
        performance: ['cpu-chart-box','memory-chart-box'],
        // 修改：将所有播放器相关的图表都归到 'player' 标签页下
        player: ['player-chart-box', 'decoder-chart-box', 'jitter-chart-box', 'demuxer-chart-box']
      };
      
      // 修改：将所有图表的ID都加入这个数组，以便统一管理
      const ids = [
        'mic-chart-box','meter-chart-box','device-chart-box',
        'algo-chart-box',
        'network-chart-box', 'network-drop-chart-box',
        'cpu-chart-box','memory-chart-box',
        'player-chart-box', 'decoder-chart-box', 'jitter-chart-box', 'demuxer-chart-box'
      ];

      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) { // 增加一个判断，避免ID不存在时报错
            el.style.display = showAll || (toShow[tabName] && toShow[tabName].includes(id)) ? 'block' : 'none';
        }
      });
      setTimeout(resizeAll, 100);
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function(){ switchTab(this.getAttribute('data-tab')); });
    });

    fileInput.addEventListener('change', (evt)=>{
      const file = evt.target.files[0];
      if (!file) return;
      filenameEl.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e)=>{
        try {
          infoEl.textContent = '文件分析中...';
          const logString = e.target.result;

          const perf = parseAndDrawPerformance(logString);
          const dev = parseAndDrawDevice(logString);
          const algo = parseAndDrawAlgo(logString);
          const net = parseAndDrawNetwork(logString);
          const playerData = parseAndDrawPlayer(logString); // 修改变量名以示区分

          const counts = [];
          if (perf.cpuResults.length || perf.memoryResults.length) counts.push(`性能:${perf.cpuResults.length + perf.memoryResults.length}`);
          if (dev.micResults.length || dev.meterResults.length || dev.deviceNameResults.length) counts.push(`设备:${dev.micResults.length + dev.meterResults.length + dev.deviceNameResults.length}`);
          if (algo.a3Results.length || algo.leakResults.length) counts.push(`算法:${algo.a3Results.length + algo.leakResults.length}`);
          if (net.rttResults.length) counts.push(`网络:${net.rttResults.length}`);
          
          // 修改：统计所有播放器相关数据点的总和
          const totalPlayerPoints = (playerData.player.length || 0) + (playerData.decoder.length || 0) + (playerData.jitter.length || 0) + (playerData.demuxer.length || 0);
          if (totalPlayerPoints > 0) counts.push(`播放器:${totalPlayerPoints}`); 

          infoEl.textContent = counts.length ? counts.join(' | ') : '没有匹配到数据!';

          // 默认切换到第一个有数据的标签页，或者保持 'all'
          switchTab('all'); // 或者可以根据counts来决定切换到哪个tab

        } catch(err){
          alert('文件解析出错：' + err);
          infoEl.textContent = '解析失败!';
        }
      };
      reader.readAsText(file);
    });

    window.addEventListener('resize', resizeAll);
  </script>
</body>
</html>